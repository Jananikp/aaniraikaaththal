# .github/workflows/deploy.yml

name: Deploy Vue App to EC2

on:
  push:
    branches: [ main ]   # Trigger on push to main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production  # Optional ‚Äî adds approval gates later

    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üîë Create SSH Key Manually
        run: |
          mkdir -p ~/.ssh
          touch ~/.ssh/testfile
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
        shell: bash


      - name: üöÄ Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@${{ secrets.EC2_PUBLIC_IP }} '
            echo "üìÅ Ensuring app directory exists..."
            mkdir -p /home/ubuntu/my-vue-app
            cd /home/ubuntu/my-vue-app

            echo "üîÑ Setting up Git repo (if not exists)..."
            if [ ! -d ".git" ]; then
              git init
              git remote add origin https://github.com/${{ github.repository }}.git
              git checkout -b main 2>/dev/null || git checkout main
            fi

            echo "‚¨áÔ∏è Fetching latest code..."
            git fetch origin main
            git reset --hard origin/main

            echo "üì¶ Installing dependencies..."
            npm install --production

            echo "üõë Stopping old process..."
            pkill -f "vite" 2>/dev/null || echo "No running Vite process"

            echo "üöÄ Starting Vue app..."
            nohup npm run dev > /home/ubuntu/app.log 2>&1 &

            echo "‚úÖ Deployment complete!"
            exit 0
          '
          '

      - name: ‚úÖ Verify Deployment (Optional)
        run: |
          sleep 10  # Wait for app to start
          curl -f https://${{ secrets.EC2_PUBLIC_IP }} || { echo "‚ùå Site not responding"; exit 1; }
